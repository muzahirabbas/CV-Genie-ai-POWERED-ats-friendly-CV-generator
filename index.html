<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV Genie - AI-Powered CV Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script>
      // Required configuration for PDF.js
      pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.worker.min.js`;
    </script>
    <style>
        :root {
            --primary-color: #4A90E2;
            --primary-hover: #357ABD;
            --background-color: #F4F7FC;
            --surface-color: #FFFFFF;
            --text-color: #333333;
            --border-color: #DDE2E8;
            --input-bg: #FFFFFF;
            --success-color: #28a745;
            --error-color: #dc3545;
            --font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        html.dark {
            --primary-color: #58A6FF;
            --primary-hover: #79B8FF;
            --background-color: #0D1117;
            --surface-color: #161B22;
            --text-color: #C9D1D9;
            --border-color: #30363D;
            --input-bg: #0D1117;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem 1rem;
        }

        .container {
            width: 100%;
            max-width: 700px;
            background-color: var(--surface-color);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 2.5rem;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .header { text-align: center; margin-bottom: 2rem; position: relative; }
        .header h1 { font-size: 2.5rem; font-weight: 700; color: var(--primary-color); }
        .header p { font-size: 1.1rem; margin-top: 0.5rem; opacity: 0.8; }
        .theme-switch-wrapper { position: absolute; top: 0; right: 0; }
        .theme-switch { display: inline-block; height: 26px; position: relative; width: 50px; }
        .theme-switch input { display: none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 26px; }
        .slider:before { background-color: #fff; bottom: 3px; content: ""; height: 20px; left: 3px; position: absolute; transition: .4s; width: 20px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(24px); }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; }
        .form-group label .required { color: var(--error-color); }
        .form-group label .optional-text { font-weight: 400; opacity: 0.7; font-size: 0.9em; }
        .form-control, .select-control { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--input-bg); color: var(--text-color); font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-control:focus, .select-control:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.25); }
        .form-control[type="password"] { font-family: 'Verdana', sans-serif; }
        .input-group { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        @media (min-width: 768px) { .input-group { grid-template-columns: 1fr 1fr; } .input-group.three-cols { grid-template-columns: 1fr 1fr 1fr; } }
        .file-input-wrapper { position: relative; display: flex; align-items: center; gap: 1rem; }
        .file-input-wrapper .btn-file { padding: 0.75rem 1rem; background-color: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; white-space: nowrap; }
        .file-input-wrapper .file-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .file-input-wrapper input[type="file"] { display: none; }
        #photo-preview { width: 70px; height: 70px; border-radius: 50%; border: 2px solid var(--border-color); object-fit: cover; display: none; margin-right: 1rem; }
        .input-method-section { border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; margin-top: 1rem; }
        textarea.form-control { min-height: 100px; resize: vertical; }
        #drop-area { border: 2px dashed var(--border-color); border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer; transition: border-color 0.3s, background-color 0.3s; }
        #drop-area.highlight { border-color: var(--primary-color); background-color: rgba(74, 144, 226, 0.05); }
        #drop-area p { margin: 0; }
        #file-grid { margin-top: 1rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 1rem; }
        .file-item { position: relative; border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem; font-size: 0.8rem; word-break: break-all; }
        .file-item img { width: 100%; height: 60px; object-fit: cover; border-radius: 4px; margin-bottom: 0.5rem; }
        .remove-file { position: absolute; top: -8px; right: -8px; background: var(--error-color); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-weight: bold; display: flex; justify-content: center; align-items: center; line-height: 1; }
        .tutorial-text { margin-top: 1rem; padding: 0.75rem 1rem; font-size: 0.9rem; opacity: 0.9; background-color: rgba(74, 144, 226, 0.05); border-left: 3px solid var(--primary-color); border-radius: 4px; }
        .tutorial-text ul { padding-left: 1.25rem; margin-top: 0.5rem; }
        .tutorial-text li { margin-bottom: 0.35rem; }
        .tutorial-text a { color: var(--primary-color); font-weight: 600; text-decoration: none; }
        .tutorial-text a:hover { text-decoration: underline; }
        .tutorial-text code { background-color: var(--border-color); padding: 2px 5px; border-radius: 4px; font-family: 'Courier New', Courier, monospace; }
        .btn-submit { width: 100%; padding: 1rem; font-size: 1.2rem; font-weight: 600; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s, transform 0.2s; }
        .btn-submit:hover:not(:disabled) { background-color: var(--primary-hover); transform: translateY(-2px); }
        .btn-submit:disabled { background-color: #6c757d; cursor: not-allowed; }
        .progress-section { display: none; text-align: center; margin-top: 1.5rem; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(0,0,0,0.1); border-left-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #progress-bar-container { width: 100%; background-color: var(--border-color); border-radius: 8px; overflow: hidden; height: 20px; }
        #progress-bar { width: 0%; height: 100%; background-color: var(--primary-color); transition: width 0.5s ease-in-out; text-align: center; color: white; font-weight: bold; line-height: 20px; }
        #progress-text { margin-top: 0.5rem; font-weight: 500; }
        #error-message { display: none; margin-top: 1rem; padding: 1rem; background-color: rgba(220, 53, 69, 0.1); color: var(--error-color); border: 1px solid var(--error-color); border-radius: 8px; }
        .footer { text-align: center; margin-top: 2rem; font-size: 0.9rem; opacity: 0.7; }
        .hidden { display: none; }
        #debug-output-container {
            margin-top: 2rem;
            border: 1px dashed var(--border-color);
            padding: 1rem;
            border-radius: 8px;
        }
        #debug-output-container h3 {
            margin-bottom: 0.5rem;
        }
        #debug-output {
            width: 100%;
            min-height: 100px;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            padding: 0.5rem;
            font-family: monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="light">
    <div class="container">
        <div class="header">
            <div class="theme-switch-wrapper">
                <label class="theme-switch" for="theme-toggle">
                    <input type="checkbox" id="theme-toggle" />
                    <span class="slider"></span>
                </label>
            </div>
            <h1>CV Genie âœ¨</h1>
            <p>Craft a professional, ATS-friendly CV from your LinkedIn profile.</p>
        </div>

        <form id="cv-form">
            <div class="input-group">
                <div class="form-group">
                    <label for="gemini-key">Gemini API Key <span class="required">*</span></label>
                    <input type="password" id="gemini-key" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="gemini-model">Gemini Model <span class="required">*</span></label>
                    <select id="gemini-model" class="select-control" required>
                        <option value="gemini-2.5-flash" selected>gemini-2.5-flash</option>
                        <option value="gemini-2.5-pro">gemini-2.5-pro</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Personal Details <span class="optional-text">(Not Mandatory)</span></label>
                <div class="input-group three-cols">
                    <input type="email" id="email" class="form-control" placeholder="your.email@example.com">
                    <input type="tel" id="phone" class="form-control" placeholder="Your Phone Number">
                    <input type="text" id="location" class="form-control" placeholder="City, Country">
                </div>
            </div>

            <div class="form-group">
                <label for="user-summary">Professional Summary <span class="optional-text">(Not Mandatory)</span></label>
                <textarea id="user-summary" class="form-control" placeholder="A brief, 2-4 sentence summary about yourself. The AI will use this as a starting point."></textarea>
            </div>

            <div class="form-group">
                <label for="profile-photo">Profile Photo <span class="required">*</span></label>
                <div class="file-input-wrapper">
                    <img id="photo-preview" src="#" alt="Profile photo preview" />
                    <label for="profile-photo" class="btn-file">Choose Photo</label>
                    <span id="photo-file-name" class="file-name">No file chosen</span>
                    <input type="file" id="profile-photo" accept="image/*" required>
                </div>
            </div>

            <div class="form-group">
                <label for="job-title">Target Job Title <span class="required">*</span></label>
                <input type="text" id="job-title" class="form-control" placeholder="e.g., Senior Frontend Developer" required>
            </div>

            <div class="form-group">
                <label>Professional URLs <span class="optional-text">(Not Mandatory)</span></label>
                <div class="input-group three-cols">
                    <input type="url" id="linkedin-url" class="form-control" placeholder="LinkedIn Profile URL">
                    <input type="url" id="github-url" class="form-control" placeholder="GitHub Profile URL">
                    <input type="url" id="portfolio-url" class="form-control" placeholder="Portfolio/Website URL">
                </div>
            </div>

            <div class="form-group">
                <label for="input-method">LinkedIn Profile Data Input <span class="required">*</span></label>
                <select id="input-method" class="select-control">
                    <option value="text" selected>Text / .txt (Recommended & Fastest)</option>
                    <option value="files">PDF / Images</option>
                </select>
                
                <div id="text-input-section" class="input-method-section">
                    <label for="linkedin-text">Paste your LinkedIn profile text here</label>
                    <textarea id="linkedin-text" class="form-control" placeholder="Go to your LinkedIn profile > More > Save to PDF. Then, copy the text from the PDF and paste it here."></textarea>
                    <label for="text-file" class="btn-file" style="margin-top: 1rem; display: inline-block;">Or Upload a .txt file</label>
                    <span id="txt-file-name"></span>
                    <input type="file" id="text-file" accept=".txt">
                    <div class="tutorial-text">
                        <strong>How to use:</strong> Go to your LinkedIn profile. Manually copy the text from each section (About, Experience, Education, etc.) and paste it here, one after the other. Alternatively, save all the text into a single <code>.txt</code> file and upload it.
                    </div>
                </div>
                
                <div id="file-input-section" class="input-method-section hidden">
                    <input type="file" id="file-upload" multiple accept="application/pdf,image/*" class="hidden">
                    <div id="drop-area">
                        <p><strong>Drag & drop PDF/image files here</strong>, or click to select files. You can also paste images from your clipboard.</p>
                    </div>
                    <div id="file-grid"></div>
                    <div class="tutorial-text">
                        <strong>How to use:</strong>
                        <ul>
                            <li><strong>Recommended Extension:</strong> Use the <a href="https://chromewebstore.google.com/detail/gofullpage-full-page-scre/fdpohaocaechififmbbbbbknoalclacl" target="_blank" rel="noopener noreferrer">GoFullPage Chrome extension</a> to take a screenshot of your entire LinkedIn profile.</li>
                            <li><strong>Print to PDF:</strong> Go to your LinkedIn profile page, press <code>Ctrl+P</code> (or <code>Cmd+P</code>), and choose "Save as PDF".</li>
                            <li><strong>Paste Screenshots:</strong> Take screenshots of different profile sections and simply paste them here from your clipboard using <code>Ctrl+V</code> (or <code>Cmd+V</code>).</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <button type="submit" id="submit-btn" class="btn-submit">Generate My CV</button>

            <div id="progress-section" class="progress-section">
                <div class="spinner"></div>
                <div id="progress-bar-container">
                    <div id="progress-bar">0%</div>
                </div>
                <p id="progress-text">Initializing...</p>
            </div>
            
            <div id="error-message"></div>
            
            <div id="debug-output-container" class="hidden">
                <h3>Frontend Extracted Text (For Debugging)</h3>
                <div id="debug-output"></div>
            </div>

        </form>

        <footer class="footer">
            <p>Powered by Muzahir Abbas</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const form = document.getElementById('cv-form');
            const submitBtn = document.getElementById('submit-btn');
            const progressSection = document.getElementById('progress-section');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const errorMessage = document.getElementById('error-message');
            const geminiKeyInput = document.getElementById('gemini-key');
            const themeToggle = document.getElementById('theme-toggle');
            const photoInput = document.getElementById('profile-photo');
            const debugContainer = document.getElementById('debug-output-container');
            const debugOutput = document.getElementById('debug-output');

            // --- Load Saved Settings ---
            const savedApiKey = localStorage.getItem('geminiApiKey');
            if (savedApiKey) geminiKeyInput.value = savedApiKey;
            geminiKeyInput.addEventListener('input', () => localStorage.setItem('geminiApiKey', geminiKeyInput.value));

            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                themeToggle.checked = true;
                document.documentElement.classList.add('dark');
                document.body.classList.remove('light');
                document.body.classList.add('dark');
            }
            
            themeToggle.addEventListener('change', () => {
                const isDark = themeToggle.checked;
                document.documentElement.classList.toggle('dark', isDark);
                document.body.classList.remove(isDark ? 'light' : 'dark');
                document.body.classList.add(isDark ? 'dark' : 'light');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });

            // --- File and UI Handlers ---
            const photoPreview = document.getElementById('photo-preview');
            const photoFileName = document.getElementById('photo-file-name');
            photoInput.addEventListener('change', () => {
                const file = photoInput.files[0];
                if (file) {
                    photoPreview.src = URL.createObjectURL(file);
                    photoPreview.style.display = 'block';
                    photoFileName.textContent = file.name;
                }
            });
            
            const inputMethodSelect = document.getElementById('input-method');
            const textSection = document.getElementById('text-input-section');
            const fileSection = document.getElementById('file-input-section');
            inputMethodSelect.addEventListener('change', (e) => {
                const isText = e.target.value === 'text';
                textSection.classList.toggle('hidden', !isText);
                fileSection.classList.toggle('hidden', isText);
            });

            const textFileInput = document.getElementById('text-file');
            const linkedInTextarea = document.getElementById('linkedin-text');
            const txtFileName = document.getElementById('txt-file-name');
            textFileInput.addEventListener('change', () => {
                const file = textFileInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        linkedInTextarea.value = e.target.result;
                        txtFileName.textContent = `Loaded: ${file.name}`;
                    };
                    reader.readAsText(file);
                }
            });

            const dropArea = document.getElementById('drop-area');
            const fileUploadInput = document.getElementById('file-upload');
            const fileGrid = document.getElementById('file-grid');
            let uploadedFiles = [];

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eName => { dropArea.addEventListener(eName, e => { e.preventDefault(); e.stopPropagation(); }, false); document.body.addEventListener(eName, e => { e.preventDefault(); e.stopPropagation(); }, false); });
            ['dragenter', 'dragover'].forEach(eName => dropArea.addEventListener(eName, () => dropArea.classList.add('highlight'), false));
            ['dragleave', 'drop'].forEach(eName => dropArea.addEventListener(eName, () => dropArea.classList.remove('highlight'), false));
            dropArea.addEventListener('drop', e => handleFiles(e.dataTransfer.files), false);
            document.addEventListener('paste', e => { if (inputMethodSelect.value === 'files') handleFiles(e.clipboardData.files); });
            dropArea.addEventListener('click', () => fileUploadInput.click());
            fileUploadInput.addEventListener('change', () => handleFiles(fileUploadInput.files));
            
            function handleFiles(files) {
                files = [...files].filter(f => ['application/pdf', 'image/jpeg', 'image/png', 'image/webp'].includes(f.type));
                files.forEach(f => { if (!uploadedFiles.some(uf => uf.name === f.name && uf.size === f.size)) uploadedFiles.push(f); });
                renderFileGrid();
            }

            function renderFileGrid() {
                fileGrid.innerHTML = '';
                uploadedFiles.forEach((file, index) => {
                    const item = document.createElement('div'); item.className = 'file-item';
                    const btn = document.createElement('button'); btn.className = 'remove-file'; btn.innerHTML = '&times;';
                    btn.onclick = e => { e.stopPropagation(); uploadedFiles.splice(index, 1); renderFileGrid(); };
                    const name = document.createElement('p'); name.textContent = file.name;
                    item.appendChild(btn);
                    if (file.type.startsWith('image/')) {
                        const img = document.createElement('img'); img.src = URL.createObjectURL(file);
                        item.appendChild(img);
                    }
                    item.appendChild(name); fileGrid.appendChild(item);
                });
            }

            // --- Client-side file processing functions ---
            async function processPdfToText(file) {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    fullText += textContent.items.map(item => item.str).join(' ') + '\n\n';
                }
                return fullText;
            }

            async function processImageToText(file, index) {
                updateProgress(5 + (index * 5), `Performing OCR on image: ${file.name}...`);
                const worker = await Tesseract.createWorker();
                await worker.loadLanguage('eng');
                await worker.initialize('eng');
                const { data: { text } } = await worker.recognize(file);
                await worker.terminate();
                return text;
            }

            function fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => {
                        const base64Data = reader.result.split(',')[1];
                        resolve({ mimeType: file.type, data: base64Data });
                    };
                    reader.onerror = error => reject(error);
                });
            }
            
            // --- Form Submission ---
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                debugContainer.classList.add('hidden');

                if (!form.checkValidity() || (inputMethodSelect.value === 'text' && !linkedInTextarea.value.trim()) || (inputMethodSelect.value === 'files' && uploadedFiles.length === 0)) {
                    alert('Please fill out all required fields and provide LinkedIn data.');
                    form.reportValidity();
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.textContent = 'Generating...';
                progressSection.style.display = 'block';
                errorMessage.style.display = 'none';
                updateProgress(0, "Initializing...");

                try {
                    let linkedinDataPayload = '';

                    if (inputMethodSelect.value === 'text') {
                        linkedinDataPayload = linkedInTextarea.value;
                        updateProgress(20, "Sending text data to worker...");
                    } else {
                        updateProgress(5, "Processing files in your browser...");
                        const textPromises = uploadedFiles.map((file, index) => {
                            if (file.type === 'application/pdf') {
                                return processPdfToText(file);
                            } else if (file.type.startsWith('image/')) {
                                return processImageToText(file, index);
                            }
                            return Promise.resolve('');
                        });
                        const texts = await Promise.all(textPromises);
                        linkedinDataPayload = texts.join('\n\n---\n\n');
                        updateProgress(30, "Uploading extracted text to worker...");
                    }
                    
                    linkedinDataPayload = linkedinDataPayload.replace(/[^\x20-\x7E\n\r\t]/g, '');

                    // Display the extracted text in the debug box
                    debugOutput.textContent = linkedinDataPayload || "No text was extracted.";
                    // HIDE DEBUG BOX: The following line is now commented out to hide the debug box from the user.
                    // debugContainer.classList.remove('hidden');

                    const profilePhotoData = await fileToBase64(photoInput.files[0]);

                    const payload = {
                        geminiApiKey: geminiKeyInput.value,
                        geminiModel: document.getElementById('gemini-model').value,
                        targetJobTitle: document.getElementById('job-title').value,
                        profilePhoto: profilePhotoData,
                        linkedinData: linkedinDataPayload,
                        personalDetails: {
                            email: document.getElementById('email').value,
                            phone: document.getElementById('phone').value,
                            location: document.getElementById('location').value,
                            summary: document.getElementById('user-summary').value
                        },
                        urls: {
                            linkedinUrl: document.getElementById('linkedin-url').value,
                            githubUrl: document.getElementById('github-url').value,
                            portfolioUrl: document.getElementById('portfolio-url').value
                        }
                    };
                    
                    const response = await fetch('https://YOUR_WORKER_NAME.YOUR_SUBDOMAIN.workers.dev/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });

                    updateProgress(40, "Data received. Agent is analyzing content...");
                    if (!response.ok) { const err = await response.json(); throw new Error(err.error || `HTTP error! Status: ${response.status}`); }
                    
                    updateProgress(60, "Extracting key information...");
                    updateProgress(80, "Curating CV and generating document...");
                    
                    const blob = await response.blob();
                    if (blob.type !== 'application/pdf') throw new Error('An unexpected error occurred. The server did not return a PDF.');
                    
                    updateProgress(100, "Success! Your CV is ready.");
                    
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none'; a.href = url;
                    a.download = `CV_Genie_${document.getElementById('job-title').value.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`;
                    document.body.appendChild(a); a.click();
                    window.URL.revokeObjectURL(url); a.remove();
                    resetUI();

                } catch (error) {
                    console.error('Submission error:', error);
                    showError(`Error: ${error.message}`);
                    resetUI();
                }
            });
            
            function updateProgress(percentage, text) { progressBar.style.width = `${percentage}%`; progressBar.textContent = `${percentage}%`; progressText.textContent = text; }
            function showError(message) { errorMessage.textContent = message; errorMessage.style.display = 'block'; }
            function resetUI() { submitBtn.disabled = false; submitBtn.textContent = 'Generate My CV'; progressSection.style.display = 'none'; updateProgress(0, ""); }
        });
    </script>
</body>
</html>